@using ACDecompileParser.Shared.Lib.Models
@using ACDecompileParser.Shared.Lib.Services
@using ACTypeBrowser.Services
@using ACTypeBrowser.Components.Tabs
@using Microsoft.AspNetCore.Components.Routing
@inject NavigationManager NavigationManager
@inject PageTitleService PageTitleService
@inject IJSRuntime JSRuntime

<div class="type-detail">
    @if (TypeGroup == null || !TypeGroup.Any())
    {
        <p class="p-4">Select a type to view details.</p>
    }
    else
    {
        <ul class="nav nav-tabs mb-2 mt-2">
            <li class="nav-item">
                <a class="nav-link @(_activeTab == "definition" ? "active" : "")"
                   @onclick='() => SelectTab("definition")'
                   style="cursor: pointer;">
                    Definition
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link @(_activeTab == "raw" ? "active" : "")"
                   @onclick='() => SelectTab("raw")'
                   style="cursor: pointer;">
                    Raw
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link @(_activeTab == "csharp" ? "active" : "")"
                   @onclick='() => SelectTab("csharp")'
                   style="cursor: pointer;">
                    C#
                </a>
            </li>
            @if (TypeGroup.Any(t => t.StaticVariables?.Any() == true))
            {
                <li class="nav-item">
                    <a class="nav-link @(_activeTab == "statics" ? "active" : "")"
                       @onclick='() => SelectTab("statics")'
                       style="cursor: pointer;">
                        Statics
                    </a>
                </li>
            }
            <li class="nav-item">
                <a class="nav-link @(_activeTab == "pipeline" ? "active" : "")"
                   @onclick='() => SelectTab("pipeline")'
                   style="cursor: pointer;">
                    Pipeline
                </a>
            </li>
        </ul>

        @if (_activeTab == "definition")
        {
            <DefinitionTab TypeGroup="TypeGroup"/>
        }
        else if (_activeTab == "statics")
        {
            <StaticsTab TypeGroup="TypeGroup"/>
        }
        else if (_activeTab == "csharp")
        {
            <CSharpTab TypeGroup="TypeGroup"/>
        }
        else if (_activeTab == "pipeline")
        {
            <div class="flex-grow-1" style="min-height: 0; overflow: hidden;">
                <PipelineFlow Type="TypeGroup.First()" PipelineItem="@PipelineItem"/>
            </div>
        }
        else
        {
            <RawTab TypeGroup="TypeGroup"/>
        }
    }
</div>

<style>
    .type-detail {
        background-color: var(--bg-primary);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* Remove padding on mobile for more screen space */
    @@media (max-width: 640.98px) {
        .type-detail {
            padding: 0.5rem !important;
        }
        
        article.content {
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
        }
    }
    
    .type-detail h3 {
        color: var(--text-primary);
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .type-detail h3 .badge {
        font-size: 0.7rem;
        font-weight: 500;
        padding: 0.35rem 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .nav-tabs {
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 1.5rem;
    }

    .nav-tabs .nav-item {
        margin-bottom: -2px;
    }

    .nav-tabs .nav-link {
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--text-secondary);
        padding: 0.75rem 1.25rem;
        font-weight: 500;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        background: transparent;
    }

    .nav-tabs .nav-link:hover {
        color: var(--link-color);
        border-bottom-color: var(--link-color);
        background: transparent;
    }

    .nav-tabs .nav-link.active {
        color: var(--link-color);
        border-bottom-color: var(--link-color);
        background: transparent;
        font-weight: 600;
    }
    
    
    .code-view {
        background-color: var(--code-bg);
        color: var(--code-text);
        padding: 1.25rem;
        border-radius: 6px;
        overflow-x: auto;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.9rem;
        transition: background-color 0.3s ease, color 0.3s ease;
        border: 1px solid var(--border-color);
        max-width: 100%;
        flex: 1;
        overflow: auto;
        min-height: 0;
    }
    
    .statics-view {
        flex: 1;
        overflow: auto;
        min-height: 0;
    }

    .code-view pre {
        margin: 0;
        white-space: pre;
        overflow-x: auto;
    }

    .code-view code {
        display: block;
        white-space: pre;
    }

    .code-view h5 {
        color: var(--text-primary);
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
        white-space: normal;
        overflow-wrap: break-word;
    }

    
    .token-keyword { 
        color: var(--token-keyword);
    }
    
    .token-typename { 
        color: var(--token-typename);
    }
    
    .token-string { 
        color: var(--token-string);
    }
    
    .token-comment { 
        color: var(--token-comment);
    }
    
    .token-number { 
        color: var(--token-number);
    }
    
    .token-punctuation { 
        color: var(--token-punctuation);
    }
    
    .token-identifier { 
        color: var(--token-identifier);
    }
    
    a.type-link {
        color: var(--type-link);
        text-decoration: underline;
        cursor: pointer;
        transition: color 0.2s ease;
    }
    
    a.type-link:hover {
        color: var(--type-link-hover);
    }
</style>


@code {
    [Parameter] public List<TypeModel>? TypeGroup { get; set; }
    [Parameter] public string? Title { get; set; }
    [Parameter] public string? ActiveTab { get; set; }
    [Parameter] public string? PipelineItem { get; set; }

    private string _activeTab = "definition";

    protected override void OnParametersSet()
    {
        _activeTab = !string.IsNullOrEmpty(ActiveTab) ? ActiveTab : "definition";
        UpdatePageTitle();
    }

    private void UpdatePageTitle()
    {
        if (TypeGroup?.Any() == true)
        {
            var firstType = TypeGroup.First();
            var title = !string.IsNullOrEmpty(Title) ? Title : firstType.BaseName;

            PageTitleService.SetTitle(builder =>
            {
                if (TypeGroup.Count == 1)
                {
                    builder.OpenElement(0, "span");
                    builder.AddAttribute(1, "class", "badge bg-secondary me-2");
                    builder.AddContent(2, firstType.Type);
                    builder.CloseElement();
                }

                builder.AddContent(3, title);
            });
        }
        else
        {
            PageTitleService.SetTitle("Type Details");
        }
    }

    private void SelectTab(string tab)
    {
        NavigationManager.NavigateTo(NavigationManager.GetUriWithQueryParameter("tab", tab));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JSRuntime.InvokeVoidAsync("hljs.highlightAll");
    }

}
